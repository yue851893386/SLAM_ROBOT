#ORB_SLAM2_Robot
##Version1.0:  
在ORB_SLAM2算法的基础上，新开一个线程用于进行octomap的构建。ZED_Depth.yaml为系统参数配置文件。系统适用于ROS系统下，配合ZED摄像头使用。启动命令如下：    
>roscore     
>roslaunch zed_wrapper zed.launch   
>rosrun ORB_SLAM2 RGBD /home/nvidia/catkin_ws/src/ORB_SLAM2/Vocabulary/ORBvoc.txt /home/nvidia/catkin_ws/src/ORB_SLAM2/Examples/ROS/ORB_SLAM2/Zed_Depth.yaml   

使用ctrl+c退出系统。使用octomap带有的octovis进行对.bt地图文件进行观察。     
  
##Version1.1:   
这个版本新添加3个线程，分别是局部地图规划线程，全局地图规划线程，通信线程。  
通信线程：  
>使用串口与下位机进行通信，下位机向上传输GPS信息以及实时机器人地磁传感器信息用于实时确定机器人的朝向。并将这些信息分发到局部路径规划线程以及全局路径规划线程中去。 

全局路径规划：  
>这个线程的作用是通过获取的GPS定位信息，知道自己的全局坐标，然后根据我们人为输入的终点全局坐标，计算出实时的全局朝向。当然这个全局朝向比较粗略，因为暂时没有接入百度地图的API，我们没得全局大地图，全局朝向是以起点直指终点计算得出的。全局朝向是我们用于指示机器人运动大方向的。以正北方向为0度，然后以顺时针增加全局朝向角度，0~360度。 

局部路径规划：  
>根据全局朝向角度，以及我们的octomap的数据，对机器人的正前方的三维地图进行二维压缩。然后根据机器人局部地图的初始建立角度，机器人实时地磁角度，全局朝向角度，对前方的二维地图进行A*的算法局部路径规划。不同的全局朝向和机器人实时朝向用于确定不同的局部规划终点。最终输出一个前方二维地图的矩阵，以及以地图的行进坐标点序列的方式输出局部路径规划的结果。 


##Verision2.0：  
从该版本开始，机器人代码分为2个分支。一个是基于阿栖机器人的AXi，一个是基于全向轮小车的Om。他们主要由于底盘不同，所以写的控制指令模式不同。该版本主要的更新在于修复各线程之间由于传感器不完全导致的不安全访问，修复路径规划系统中一些BUG，添加路径规划的平滑策略，添加机器人的相关控制逻辑。   
修复传感器不完全导致错误的BUG：  
>由于系统需要使用地磁传感器，GPS，摄像头等所有传感器均能正常工作的时候才能正常运行。如果一旦其中一个传感器崩溃，系统理应进行相关处理，而不是仍由其跑飞。这里添加当某种传感器出错后的紧急应对措施，以及相关提醒，防止当错误情况发生时造成意外崩溃。   
而路径规划是其中最重要的部分。路径规划的开始，必须由点云线程和全局路径规划线程均就位才行。也就是必须当局部3D地图第一帧收录后，以及通过GPS定位将全局路径规划出来后才开始正式的局部路径规划以及发送控制指令。  

修复路径规划中的BUG：  
>原来的路径规划代码，是最简单的A*算法。这里我们将A*的H计算公式，由曼哈顿距离，改为斜直距离，这样更加符合我们机器人的行动模式。  

路径规划平滑策略：  
>由于A*算法的结果是得到一些列的前进点，这样不利于我们对于小车的控制。这里采用添加拐角惩罚的优化算法，对小车的形式轨迹进行优化，并进行直行检测后去掉中间点。使最后得到的小车轨迹是少量且少拐角的规划路径。

机器人的相关控制策略：   
>由于有AXi和Om两种不同底盘的机器人，他们的行动模式各有不同。现在根据其具体行动模式，对其各个添加相应的机器人底盘控制代码，通过通信进程发送给机器人，使其进行运动。  


#Verision2.1：
该版本是基于Om小车也就是全向轮小车的框架进行的开发。主要修复了系统的路径规划以往需在第2个关键帧后才能进行的BUG，以及注释添加了无显示器模式，添加了跟踪丢失过后的应对措施。具体如下：    
修复了octomap建图在第二个关键帧才启动的BUG:    
>原来pointcloud线程是通过创建新的关键帧时才获得帧，而没有获得初始化的第一帧。而局部路径规划是在pointcloud线程启动后才能运行的。现在在SLAM系统初始化的过程中，会把第一帧传递给pointcloud线程，达到一开机小车就能进行运动规划。    

添加无显示屏模式:    
>这个需要在ros-rgbd文件里面，在初始化SLAM系统时，将viewer的输入改为false即可。

跟踪丢失的相关操作:    
>在小车的运动过程中，会出现ORBSLAM跟踪失败的情况。现在当这种情况发生后，我们会令小车原地停止下来，也即不再发送路径规划指令。同时如果当30s后，小车都未重定位成功，表示此时小车已经彻底跟踪失败。此时我们清除掉原始SLAM系统中所有的数据，包括关键帧，以及OCTOMAP。并对系统进行重置，使小车以目前为坐标（0,0）重新开始路径规划。
